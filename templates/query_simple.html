{% extends "base.html" %}

{% block title %}IFC-Daten abfragen{% endblock %}

{% block content %}
<div class="query-page">
    <div class="page-header">
        <h2>IFC-Daten abfragen</h2>
        <div class="filename-list">
            <p><strong>Geladene Dateien:</strong></p>
            <ul>
            {% for filename in filenames %}
                <li>{{ filename }}</li>
            {% endfor %}
            </ul>
        </div>
        <div class="complete-list-button-container">
            <a href="{{ url_for('complete_object_list') }}" class="btn btn-primary btn-complete-list">
                üìã Vollst√§ndige Objektliste anzeigen
            </a>
            <p class="hint">Zeigt alle IFC-Objekte mit Anzahl, sortiert nach Geschoss</p>
        </div>
    </div>

    <div class="query-interface">
        <div class="query-sidebar">
            <h3>Ansichtsmodus</h3>
            <div class="view-mode-tabs">
                <button class="view-mode-button active" data-view="storey">
                    Nach Geschoss
                </button>
                <button class="view-mode-button" data-view="mep">
                    Nach TGA
                </button>
            </div>

            <h3 style="margin-top: 2rem;">Abfragetyp</h3>
            <div class="category-tabs">
                <button class="tab-button active" data-category="quantity">
                    Z√§hlung & Menge
                </button>
                <button class="tab-button" data-category="lengths">
                    L√§ngen & Volumen
                </button>
                <button class="tab-button" data-category="spaces">
                    R√§ume & Fl√§chen
                </button>
            </div>
        </div>

        <div class="query-content">
            <!-- Quantity & Counting -->
            <div class="category-panel active" data-category="quantity">
                <h3>Z√§hlung & Menge</h3>
                <p class="category-description">Elemente in Ihrem Geb√§ude z√§hlen</p>

                <!-- By Storey View -->
                <div class="view-panel active" data-view="storey">
                    <div class="query-card">
                        <h4>Elemente nach Geschoss z√§hlen</h4>
                        <form class="query-form" data-query="count_by_storey">
                            <div class="form-group">
                                <label>Elementtyp:</label>
                                <select name="element_type" id="quantity_storey_select" required>
                                    <option value="">-- Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Gesamtanzahl</h4>
                        <form class="query-form" data-query="count_total">
                            <div class="form-group">
                                <label>Elementtyp:</label>
                                <select name="element_type" id="quantity_total_select" required>
                                    <option value="">-- Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>

                <!-- By MEP View -->
                <div class="view-panel" data-view="mep">
                    <div class="query-card">
                        <h4>TGA-Elemente nach System</h4>
                        <form class="query-form" data-query="elements_by_system">
                            <div class="form-group">
                                <label>Nach Systemname filtern (optional):</label>
                                <input type="text" name="system_name" placeholder="Leer lassen f√ºr alle Systeme">
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Z√§hlung nach TGA-Elementtyp</h4>
                        <form class="query-form" data-query="count_total">
                            <div class="form-group">
                                <label>TGA-Elementtyp:</label>
                                <select name="element_type" id="quantity_mep_select" required>
                                    <option value="">-- TGA-Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Lengths & Volumes -->
            <div class="category-panel" data-category="lengths">
                <h3>L√§ngen & Volumen</h3>
                <p class="category-description">Gesamtl√§ngen und Fl√§chen berechnen</p>

                <!-- By Storey View -->
                <div class="view-panel active" data-view="storey">
                    <div class="query-card">
                        <h4>Gesamtl√§nge nach Geschoss</h4>
                        <form class="query-form" data-query="length_by_storey">
                            <div class="form-group">
                                <label>Linienelementtyp:</label>
                                <select name="element_type" id="length_storey_select" required>
                                    <option value="">-- Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Gesamtl√§nge (Geb√§udeweit)</h4>
                        <form class="query-form" data-query="total_length">
                            <div class="form-group">
                                <label>Linienelementtyp:</label>
                                <select name="element_type" id="length_total_select" required>
                                    <option value="">-- Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Gesamtfl√§che</h4>
                        <form class="query-form" data-query="total_area">
                            <div class="form-group">
                                <label>Fl√§chenelementtyp:</label>
                                <select name="element_type" id="area_select" required>
                                    <option value="">-- Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>

                <!-- By MEP View -->
                <div class="view-panel" data-view="mep">
                    <div class="query-card">
                        <h4>TGA-Gesamtl√§ngen nach System</h4>
                        <form class="query-form" data-query="length_by_system">
                            <div class="form-group">
                                <label>TGA-Linienelementtyp:</label>
                                <select name="element_type" id="length_mep_select" required>
                                    <option value="">-- TGA-Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Gesamtl√§nge nach TGA-Typ</h4>
                        <form class="query-form" data-query="total_length">
                            <div class="form-group">
                                <label>TGA-Linienelementtyp:</label>
                                <select name="element_type" id="length_mep_total_select" required>
                                    <option value="">-- TGA-Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Spaces & Rooms -->
            <div class="category-panel" data-category="spaces">
                <h3>R√§ume & Fl√§chen</h3>
                <p class="category-description">R√§ume in Ihrem Geb√§ude auflisten und analysieren</p>

                <!-- By Storey View -->
                <div class="view-panel active" data-view="storey">
                    <div class="query-card">
                        <h4>Alle R√§ume/Fl√§chen z√§hlen</h4>
                        <form class="query-form" data-query="count_rooms">
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Nettofl√§che pro Geschoss</h4>
                        <form class="query-form" data-query="net_area_per_storey">
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>Fl√§che nach Raumtyp</h4>
                        <form class="query-form" data-query="area_by_space_type">
                            <div class="form-group">
                                <label>Raumtyp (Name enth√§lt):</label>
                                <input type="text" name="space_type" placeholder="z. B. B√ºro, Badezimmer" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>

                <!-- By MEP View -->
                <div class="view-panel" data-view="mep">
                    <div class="query-card">
                        <h4>R√§ume mit TGA-Elementen</h4>
                        <form class="query-form" data-query="elements_per_space">
                            <div class="form-group">
                                <label>TGA-Elementtyp:</label>
                                <select name="element_type" id="space_mep_select" required>
                                    <option value="">-- TGA-Elementtyp ausw√§hlen --</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>

                    <div class="query-card">
                        <h4>R√§ume/Fl√§chen z√§hlen</h4>
                        <form class="query-form" data-query="count_rooms">
                            <button type="submit" class="btn btn-primary">Abfrage ausf√ºhren</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="results-section" id="results" style="display: none;">
        <h3>Abfrageergebnisse</h3>
        <div id="results-content"></div>
    </div>
</div>

<script>
// Available element types from server
const availableElements = {{ element_types | tojson }};
const elementTranslations = {{ element_translations | tojson }};

// Function to get display name for an IFC element (German name / IFC name)
function getDisplayName(ifcName) {
    let germanName = ifcName;
    let ifcTechnicalName = ifcName;
    
    // Get German name if available
    if (elementTranslations[ifcName]) {
        germanName = elementTranslations[ifcName];
    } else if (ifcName.startsWith('Ifc')) {
        germanName = ifcName.substring(3);
    }
    
    // Get IFC technical name (without 'Ifc' prefix)
    if (ifcName.startsWith('Ifc')) {
        ifcTechnicalName = ifcName.substring(3);
    }
    
    // Return format: "German name / IFC name"
    return `${germanName} / ${ifcTechnicalName}`;
}

// Categorize elements
const countableElements = [];
const linearElements = [];
const areaElements = [];
const mepElements = [];

availableElements.forEach(elem => {
    // Add all to countable
    countableElements.push(elem);
    
    // Check if linear (pipes, ducts, cables)
    if (elem.includes('Segment') || elem.includes('Conduit')) {
        linearElements.push(elem);
    }
    
    // Check if area (slabs, coverings)
    if (elem.includes('Slab') || elem.includes('Covering') || elem.includes('Roof')) {
        areaElements.push(elem);
    }
    
    // Check if MEP
    if (elem.includes('Pipe') || elem.includes('Duct') || elem.includes('Cable') || 
        elem.includes('Outlet') || elem.includes('Switch') || elem.includes('Light') ||
        elem.includes('Sensor') || elem.includes('Valve') || elem.includes('Pump') ||
        elem.includes('Fan') || elem.includes('Terminal') || elem.includes('Sanitary') ||
        elem.includes('Distribution') || elem.includes('Electric')) {
        mepElements.push(elem);
    }
});

// Populate dropdowns
function populateSelect(selectId, elements) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Clear existing options except first
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Add available elements with German name / IFC name format
    elements.forEach(elem => {
        const option = document.createElement('option');
        option.value = elem;
        option.textContent = getDisplayName(elem);
        select.appendChild(option);
    });
}

// Populate all selects on page load
document.addEventListener('DOMContentLoaded', function() {
    // Quantity selects
    populateSelect('quantity_storey_select', countableElements);
    populateSelect('quantity_total_select', countableElements);
    populateSelect('quantity_mep_select', mepElements);
    
    // Length selects
    populateSelect('length_storey_select', linearElements);
    populateSelect('length_total_select', linearElements);
    populateSelect('length_mep_select', mepElements.filter(e => e.includes('Segment') || e.includes('Conduit')));
    populateSelect('length_mep_total_select', mepElements.filter(e => e.includes('Segment') || e.includes('Conduit')));
    
    // Area selects
    populateSelect('area_select', areaElements);
    
    // Space MEP select
    populateSelect('space_mep_select', mepElements);
});
</script>
<script src="{{ url_for('static', filename='js/query_simple.js') }}"></script>
{% endblock %}
